<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D 标注 Demo - Semantic Annotation</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23333' width='32' height='32' rx='4'/><text x='16' y='22' font-size='16' text-anchor='middle' fill='%23fff' font-family='sans-serif'>3</text></svg>">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- 3D Canvas -->
    <div id="canvas-container">
      <canvas id="canvas"></canvas>
      <canvas id="callout-canvas"></canvas>
      <div id="selection-rect" class="hidden"></div>
      <div id="loader">加载中...</div>
      <div id="hint">左键选择 · 右键拖拽旋转 · 中键滚轮缩放 · Alt+左键拖拽框选</div>
      <div id="box-edit-toolbar" class="box-edit-toolbar hidden">
        <span class="box-edit-toolbar-label">框编辑</span>
        <button type="button" data-box-edit-mode="translate" title="移动">移动</button>
        <button type="button" data-box-edit-mode="rotate" title="旋转">旋转</button>
        <button type="button" id="btn-box-edit-cancel" title="取消编辑">取消</button>
      </div>
    </div>

    <!-- 右侧面板 -->
    <aside id="panel">
      <section class="panel-section" id="auth-section">
        <h2>用户</h2>
        <div id="auth-logged-out">
          <input type="email" id="auth-email" placeholder="邮箱" />
          <input type="password" id="auth-password" placeholder="密码" />
          <div class="auth-actions">
            <button id="btn-login">登录</button>
            <button id="btn-register">注册</button>
          </div>
        </div>
        <div id="auth-logged-in" class="hidden">
          <span id="auth-user-email"></span>
          <button id="btn-logout">登出</button>
        </div>
        <div id="auth-status" class="auth-status"></div>
      </section>
      <section class="panel-section">
        <h2>加载模型</h2>
        <input type="file" id="model-input" accept=".glb,.gltf,.obj" />
        <input type="text" id="model-name-input" placeholder="模型名称（可选）" class="model-name-input" />
        <button id="btn-default-model">加载示例建筑</button>
        <div class="tileset-load">
          <input type="text" id="tileset-url-input" placeholder="/terra_b3dms/tileset.json 或 /public/terra_b3dms/tileset.json" class="tileset-url-input" />
          <div class="tileset-actions">
            <button id="btn-load-tileset">加载 3D Tiles</button>
            <button type="button" id="btn-debug-tileset" title="在控制台输出 3D Tiles 加载状态">诊断</button>
          </div>
          <div class="tileset-rotation">
            <span class="tileset-rotation-title">旋转校正 (度)</span>
            <div class="tileset-rotation-inputs">
              <label for="tileset-rot-x">X</label>
              <input type="number" id="tileset-rot-x" placeholder="0" step="0.5" value="133" title="绕 X 轴" />
              <label for="tileset-rot-y">Y</label>
              <input type="number" id="tileset-rot-y" placeholder="0" step="0.5" value="-10" title="绕 Y 轴" />
              <label for="tileset-rot-z">Z</label>
              <input type="number" id="tileset-rot-z" placeholder="0" step="0.5" value="130" title="绕 Z 轴（原倾斜校正）" />
            </div>
            <button type="button" id="btn-apply-tilt">应用</button>
            <button type="button" id="btn-check-tilt" title="检查 tileset 数据是否自带旋转">检查倾斜</button>
          </div>
          <div class="tileset-lod">
            <span class="tileset-lod-title">LOD 加载距离</span>
            <div class="tileset-lod-row">
              <input type="range" id="tileset-lod-range" min="0.5" max="12" step="0.5" value="2" title="值越小，越远即加载精细瓦片" />
              <input type="number" id="tileset-lod-input" min="0.5" max="20" step="0.5" value="2" title="屏幕空间误差目标（像素）" />
            </div>
            <span class="tileset-lod-hint">值越小越远加载精细，越大越近才加载</span>
          </div>
          <div class="tileset-material">
            <span class="tileset-material-title">Tile 材质</span>
            <div class="tileset-material-row">
              <label for="tileset-material-opacity">透明度</label>
              <input type="range" id="tileset-material-opacity" min="0" max="1" step="0.05" value="1" title="0=全透明 1=不透明" />
              <span id="tileset-material-opacity-value" class="tileset-material-value">100%</span>
            </div>
          </div>
        </div>
        <div id="model-list-section">
          <h3 class="model-list-title">我的模型</h3>
          <ul id="model-list"></ul>
        </div>
      </section>

      <section class="panel-section">
        <h2>标注方式</h2>
        <div class="mode-toggle">
          <button id="btn-annot-mode-mesh" class="mode-btn active">按模型选择</button>
          <button id="btn-annot-mode-worldbox" class="mode-btn">按框绘制 (WorldBox)</button>
        </div>
        <div id="mesh-selection-options" class="selection-options">
          <span class="selection-options-label">选择模式</span>
          <button id="btn-mode-object" class="mode-btn active">物体</button>
          <button id="btn-mode-face" class="mode-btn">面</button>
          <label class="selection-high-lod"><input type="checkbox" id="chk-selection-high-lod" /> 高精度选择（面模式）</label>
        </div>
      </section>

      <section class="panel-section" id="lighting-section">
        <h2>灯光调节</h2>
        <div class="lighting-row">
          <label for="light-exposure">渲染器曝光</label>
          <input type="range" id="light-exposure" min="0.5" max="2" step="0.05" value="1" />
          <span id="light-exposure-value" class="lighting-value">1.00</span>
        </div>
        <div class="lighting-row">
          <label for="light-ambient">环境光</label>
          <input type="range" id="light-ambient" min="0" max="2" step="0.05" value="0.5" />
          <span id="light-ambient-value" class="lighting-value">0.50</span>
        </div>
        <div class="lighting-row">
          <label for="light-dir">主方向光</label>
          <input type="range" id="light-dir" min="0" max="2" step="0.05" value="0.85" />
          <span id="light-dir-value" class="lighting-value">0.85</span>
        </div>
        <div class="lighting-row">
          <label for="light-fill">补光</label>
          <input type="range" id="light-fill" min="0" max="1" step="0.05" value="0.25" />
          <span id="light-fill-value" class="lighting-value">0.25</span>
        </div>
      </section>

      <section class="panel-section">
        <h2>当前选择</h2>
        <div id="selection-info">未选择</div>
        <div id="annotation-form" class="hidden">
          <input type="text" id="annot-label" placeholder="标签 (如: 商铺)" />
          <input type="text" id="annot-category" placeholder="分类 (如: Commercial)" />
          <textarea id="annot-description" placeholder="描述该区域包含的模型结构（500字以内）" rows="3" maxlength="500"></textarea>
          <span id="annot-description-count" class="description-count">0 / 500</span>
          <input type="color" id="annot-color" value="#FF9900" title="颜色" />
          <button id="btn-add-annotation">新建标注</button>
          <div id="add-to-annot-row" class="hidden">
            <select id="annot-target-select"></select>
            <button id="btn-add-to-annot">添加到已有标注</button>
          </div>
        </div>
      </section>

      <section class="panel-section">
        <h2>标注层</h2>
        <div class="opacity-control">
          <label for="annot-opacity">着色透明度</label>
          <input type="range" id="annot-opacity" min="0.1" max="1" step="0.05" value="0.45" />
          <span id="opacity-value">45%</span>
        </div>
        <div id="persist-controls">
          <button id="btn-save">保存标注</button>
          <button id="btn-load">加载标注</button>
          <button id="btn-export">导出标注</button>
        </div>
        <div id="persist-status" class="persist-status"></div>
        <ul id="annotation-list"></ul>
      </section>
    </aside>
  </div>

  <script src="js/config.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
      "three/examples/jsm/loaders/GLTFLoader.js": "/js/gltf-loader-with-draco.js",
      "three/examples/jsm/loaders/DRACOLoader.js": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/DRACOLoader.js",
      "three/examples/jsm/loaders/KTX2Loader.js": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/KTX2Loader.js",
      "3d-tiles-renderer": "https://cdn.jsdelivr.net/npm/3d-tiles-renderer@0.4.21/build/index.js",
      "3d-tiles-renderer/three/plugins": "https://cdn.jsdelivr.net/npm/3d-tiles-renderer@0.4.21/build/index.three-plugins.js"
    }
  }
  </script>
  <script type="module" src="js/main.js"></script>
</body>
</html>
